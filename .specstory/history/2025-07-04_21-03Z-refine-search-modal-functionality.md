<!-- Generated by SpecStory -->

# Refine search modal functionality (2025-07-04 21:03Z)

_**User**_

My previous chat with you got stuck. Here I pase our last exchange in that conversation so we can tak it from there. If you need more context you can view ealier version of our converrsation in .specstory/history

From you:

The modal is now compact and visually appealing, and the search logic only allows adding users who are either in your "followers" or "following" lists.
	•	The linter errors are fixed by explicitly typing the user data.
Result:
	•	Only users you follow or who follow you will appear in the search results.
	•	The modal is always a reasonable size and centered.
If you want to further refine the experience (e.g., show avatars in the search, add a “no friends found” message, etc.), just let me know!

My feedback:

Let's refine:
Can't see users when searching.
Can't get out of search modal.
I appear as offline.

Fix these and add suggested improvements

---

_**Assistant**_

I can see the issues you're experiencing with the search modal. Let me examine the current implementation and fix these problems.


---

<details>
            <summary>Searched codebase "search modal users followers following" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/components/Collaboration/ScreenplayViewer.tsx` | L967-1002 |
| `src/components/Social/SocialDashboard.tsx` | L23-41 |
| `src/components/Social/SocialDashboard.tsx` | L208-233 |
| `src/components/Social/SocialDashboard.tsx` | L233-263 |
| `src/components/Social/SocialDashboard.tsx` | L93-147 |
| `src/components/Social/ActivityFeed.tsx` | L13-44 |
| `src/components/Social/SocialDashboard.tsx` | L41-93 |
| `src/components/Collaboration/ScreenplayViewer.scss` | L2434-2498 |
| `src/components/Social/FollowButton.tsx` | L11-75 |
| `src/components/Chat/ChatInterface.tsx` | L942-1014 |
| `src/components/Social/FollowButton.tsx` | L119-154 |
| `src/components/Social/SocialDashboard.tsx` | L382-436 |
| `src/components/Chat/ChatInterface.tsx` | L1014-1066 |
| `src/components/Social/SocialDashboard.tsx` | L147-208 |
| `src/components/Collaboration/ScreenplayViewer.tsx` | L1741-1777 |
| `src/components/Social/SocialDashboard.tsx` | L1-23 |
| `src/components/Collaboration/CollaborationHub.tsx` | L327-370 |
| `src/components/Collaboration/CollaborationHub.scss` | L893-950 |
| `src/utilities/socialService.ts` | L255-294 |
| `src/components/Collaboration/CollaborationHub.tsx` | L1137-1177 |
| `src/components/Social/SocialDashboard.tsx` | L287-316 |
| `src/utilities/socialService.ts` | L753-768 |
| `src/components/Social/ActivityFeed.tsx` | L451-481 |
| `src/components/Social/SocialDashboard.tsx` | L263-287 |
| `src/components/Social/FollowButton.tsx` | L1-11 |

</details>

---

Now let me look at the specific search modal implementation to understand the issues:


---

Read file: src/components/Collaboration/ScreenplayViewer.tsx

---

Now let me check the user search logic and the modal styling:


---

Read file: src/components/Collaboration/ScreenplayViewer.tsx

---

Now let me check the modal styling to understand the close button issue:


---

Read file: src/components/Collaboration/ScreenplayViewer.scss

---

Now let me check the user presence/online status logic:


---

<details>
            <summary>Searched codebase "online status presence user offline" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/types/Chat.ts` | L138-150 |
| `src/components/Collaboration/ScreenplayViewer.tsx` | L1349-1387 |
| `src/components/Collaboration/ScreenplayViewer.tsx` | L542-594 |
| `src/components/Collaboration/ScreenplayViewer.tsx` | L484-542 |
| `src/components/Chat/ChatInterface.tsx` | L1320-1346 |
| `src/components/Networking/NetworkingHub.scss` | L187-266 |
| `src/components/Collaboration/ScreenplayViewer.tsx` | L426-484 |
| `src/components/Collaboration/ScreenplayViewer.scss` | L382-455 |
| `src/components/Chat/ChatInterface.tsx` | L1607-1643 |
| `src/components/Social/AdvancedMessaging.tsx` | L245-277 |
| `src/components/Collaboration/CollaborativeDocumentEditor.tsx` | L187-228 |
| `src/components/Collaboration/WhiteboardCanvas.scss` | L181-273 |
| `src/components/Collaboration/CollaborativeDocumentEditor.scss` | L132-234 |
| `src/types/Chat.ts` | L59-69 |
| `src/utilities/messagingService.ts` | L346-392 |
| `src/types/Social.ts` | L241-273 |
| `src/components/Chat/ChatTestPage.tsx` | L289-327 |
| `src/utilities/messagingService.ts` | L501-529 |
| `src/utilities/messagingService.ts` | L1-36 |
| `src/components/Social/AdvancedMessaging.scss` | L1-83 |
| `src/utilities/messagingService.ts` | L466-487 |
| `src/components/Chat/ChatTestPage.tsx` | L51-87 |
| `src/components/Chat/ChatInterface.tsx` | L1365-1404 |
| `src/components/Collaboration/CollaborationHub.tsx` | L896-917 |
| `src/components/Chat/ChatInterface.scss` | L285-361 |

</details>

---

Now I understand the issues. Let me fix them one by one:

1. **Can't see users when searching** - The search logic is too restrictive, only searching users in followers/following
2. **Can't get out of search modal** - The close button might not be working properly
3. **I appear as offline** - The presence system needs to be properly initialized

Let me fix these issues:


---

```diff
  import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
- import { collection, addDoc, query, where, orderBy, getDocs, onSnapshot, updateDoc, doc, deleteDoc, arrayUnion, arrayRemove } from 'firebase/firestore';
+ import { collection, addDoc, query, where, orderBy, getDocs, onSnapshot, updateDoc, doc, deleteDoc, arrayUnion, arrayRemove, limit } from 'firebase/firestore';
  import { Document, Page, pdfjs } from 'react-pdf';
  import { db } from '../../firebase';
```

```diff
    const [showAddCollaboratorModal, setShowAddCollaboratorModal] = useState(false);
    const [collaboratorSearch, setCollaboratorSearch] = useState('');
-   const [collaboratorResults, setCollaboratorResults] = useState<Array<{id: string; name?: string; email?: string; avatar?: string; role?: string;}>>([]);
+   const [collaboratorResults, setCollaboratorResults] = useState<Array<{id: string; name?: string; email?: string; avatar?: string; role?: string; isFollowing: boolean}>>([]);
    const [addingCollaborator, setAddingCollaborator] = useState(false);
    const [collaborators, setCollaborators] = useState<any[]>([]);
```

```diff
      const fetchFollows = async () => {
        if (!currentUser) return;
-       const userRef = doc(db, 'users', currentUser.uid);
-       const userSnap = await getDocs(query(collection(db, 'users'), where('id', '==', currentUser.uid)));
-       if (!userSnap.empty) {
-         const data = userSnap.docs[0].data();
-         const followers = Array.isArray(data.followers) ? data.followers : [];
-         const following = Array.isArray(data.following) ? data.following : [];
-         setUserFollows(Array.from(new Set([...followers, ...following])));
+       try {
+         // Get user's followers and following from social data
+         const userSnap = await getDocs(query(collection(db, 'users'), where('id', '==', currentUser.uid)));
+         if (!userSnap.empty) {
+           const data = userSnap.docs[0].data();
+           const followers = Array.isArray(data.followers) ? data.followers : [];
+           const following = Array.isArray(data.following) ? data.following : [];
+           setUserFollows(Array.from(new Set([...followers, ...following])));
+         }
+       } catch (error) {
+         console.error('Error fetching follows:', error);
+         // If we can't get follows, we'll still allow searching all users
+         setUserFollows([]);
        }
      };
```

```diff
    const handleCollaboratorSearch = async (queryStr: string) => {
      setCollaboratorSearch(queryStr);
-     if (!queryStr.trim() || userFollows.length === 0) {
+     if (!queryStr.trim()) {
        setCollaboratorResults([]);
        return;
      }
-     // Only search users in userFollows
-     const usersRef = collection(db, 'users');
-     const q = query(usersRef, where('id', 'in', userFollows));
-     const snap = await getDocs(q);
-     const filtered = snap.docs
-       .map(doc => ({ id: doc.id, ...(doc.data() as { name?: string; email?: string; avatar?: string; role?: string }) }))
-       .filter(user =>
-         (typeof user.name === 'string' && user.name.toLowerCase().includes(queryStr.toLowerCase())) ||
-         (typeof user.email === 'string' && user.email.toLowerCase().includes(queryStr.toLowerCase()))
-       );
-     setCollaboratorResults(filtered);
+     
+     try {
+       // Search all users, not just followers/following
+       const usersRef = collection(db, 'users');
+       
+       // First try to search by displayName
+       const nameQuery = query(
+         usersRef, 
+         where('displayName', '>=', queryStr),
+         where('displayName', '<=', queryStr + '\uf8ff'),
+         limit(10)
+       );
+       
+       // Also search by email
+       const emailQuery = query(
+         usersRef,
+         where('email', '>=', queryStr),
+         where('email', '<=', queryStr + '\uf8ff'),
+         limit(10)
+       );
+ 
+       const [nameSnap, emailSnap] = await Promise.all([
+         getDocs(nameQuery),
+         getDocs(emailQuery)
+       ]);
+ 
+       // Combine and deduplicate results
+       const allDocs = [...nameSnap.docs, ...emailSnap.docs];
+       const uniqueDocs = allDocs.filter((doc, index, self) => 
+         index === self.findIndex(d => d.id === doc.id)
+       );
+ 
+       const filtered = uniqueDocs
+         .map(doc => {
+           const data = doc.data();
+           return {
+             id: doc.id,
+             name: data.displayName || data.firstName || data.name || `User ${doc.id.slice(-4)}`,
+             email: data.email || '',
+             avatar: data.avatarUrl || data.avatar || '',
+             role: data.role || 'User',
+             isFollowing: userFollows.includes(doc.id)
+           };
+         })
+         .filter(user => 
+           user.id !== currentUser?.uid && // Don't show current user
+           (user.name.toLowerCase().includes(queryStr.toLowerCase()) ||
+            user.email.toLowerCase().includes(queryStr.toLowerCase()))
+         )
+         .slice(0, 10);
+ 
+       setCollaboratorResults(filtered);
+     } catch (error) {
+       console.error('Error searching users:', error);
+       setCollaboratorResults([]);
+     }
    };
  
```

---

Now let me fix the modal close button and improve the modal styling:


---

```diff
  
          {showAddCollaboratorModal && (
-           <div className="modal-overlay">
+           <div 
+             className="modal-overlay"
+             onClick={(e) => {
+               if (e.target === e.currentTarget) {
+                 setShowAddCollaboratorModal(false);
+                 setCollaboratorSearch('');
+                 setCollaboratorResults([]);
+               }
+             }}
+             onKeyDown={(e) => {
+               if (e.key === 'Escape') {
+                 setShowAddCollaboratorModal(false);
+                 setCollaboratorSearch('');
+                 setCollaboratorResults([]);
+               }
+             }}
+             tabIndex={-1}
+           >
              <div className="modal-content">
                <div className="modal-header">
                  <h3>Add Collaborator</h3>
-                 <button onClick={() => setShowAddCollaboratorModal(false)} className="close-btn">×</button>
+                 <button 
+                   onClick={() => {
+                     setShowAddCollaboratorModal(false);
+                     setCollaboratorSearch('');
+                     setCollaboratorResults([]);
+                   }} 
+                   className="close-btn"
+                   aria-label="Close modal"
+                 >
+                   ×
+                 </button>
                </div>
                <div className="modal-body">
```

```diff
                    onChange={e => handleCollaboratorSearch(e.target.value)}
                    className="collaborator-search-input"
+                   autoFocus
                  />
                  <div className="collaborator-search-results">
-                   {collaboratorResults.length === 0 && <div className="no-results">No users found.</div>}
+                   {collaboratorResults.length === 0 && collaboratorSearch.trim() && (
+                     <div className="no-results">
+                       <p>No users found matching "{collaboratorSearch}"</p>
+                       <p className="search-tip">Try searching by name or email address</p>
+                     </div>
+                   )}
+                   {collaboratorResults.length === 0 && !collaboratorSearch.trim() && (
+                     <div className="no-results">
+                       <p>Start typing to search for users</p>
+                     </div>
+                   )}
                    {collaboratorResults.map(user => (
                      <div key={user.id} className="user-result">
                        <div className="user-info">
+                         <div className="user-avatar">
+                           {user.avatar ? (
+                             <img src={user.avatar} alt={user.name} />
+                           ) : (
+                             <div className="avatar-placeholder">
+                               {user.name?.charAt(0).toUpperCase() || 'U'}
+                             </div>
+                           )}
+                           {user.isFollowing && (
+                             <div className="following-badge" title="You follow this user">✓</div>
+                           )}
+                         </div>
+                         <div className="user-details">
                            <span className="user-name">{user.name}</span>
                            <span className="user-email">{user.email}</span>
+                           {user.role && <span className="user-role">{user.role}</span>}
                          </div>
-                       <button disabled={addingCollaborator} onClick={() => handleAddCollaborator(user)} className="add-btn">Add</button>
+                       </div>
+                       <button 
+                         disabled={addingCollaborator} 
+                         onClick={() => handleAddCollaborator(user)} 
+                         className="add-btn"
+                       >
+                         {addingCollaborator ? 'Adding...' : 'Add'}
+                       </button>
                      </div>
                    ))}
```

---

Now let me update the CSS to support the new modal features:


---



---



---

